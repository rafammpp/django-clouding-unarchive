<style>
    .django-unarchive {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        margin: 1rem 0;
        gap: 1rem;
        cursor: pointer;
    }

    .django-unarchive .server_status_display {
        text-transform: capitalize;
    }

    .django-unarchive .active{
        color: green;
    }

    .django-unarchive .no-active{
        color: red;
    }

    .django-unarchive .loader {
        width: 1.7rem;
        height: 1.7rem;
        border-radius: 50%;
        position: relative;
        animation: rotate 1s linear infinite
    }

    .django-unarchive .loader::before {
        content: "";
        box-sizing: border-box;
        position: absolute;
        inset: 0px;
        border-radius: 50%;
        border: 0.25rem solid #bababa;
        animation: prixClipFix 2s linear infinite ;
    }

    @keyframes rotate {
    100%   {transform: rotate(360deg)}
    }

    @keyframes prixClipFix {
        0%   {clip-path:polygon(50% 50%,0 0,0 0,0 0,0 0,0 0)}
        25%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 0,100% 0,100% 0)}
        50%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,100% 100%,100% 100%)}
        75%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,0 100%,0 100%)}
        100% {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,0 100%,0 0)}
    }
</style>

<button
    type="button"
    disabled="disabled"
    class="django-unarchive {{ css_classes }}"
    data-on-success-url="{{ on_success_url }}"
    data-test-on-success-url="{% if test_on_success_url %}test{% endif %}"
    data-status-url="{% url 'django_clouding_unarchive:server-status' %}{% if server_id %}?server_id={{ server_id }}{% endif %}"
    data-unarchive-url="{% url 'django_clouding_unarchive:unarchive-server' %}{% if server_id %}?server_id={{ server_id }}{% endif %}"
    data-friendly-messages="{% if friendly_messages %}friendly{% endif %}"
    data-server-name="{{ server_name }}"
    data-setup=""
    data-status=""
    data-ready=""
><span class="server_status_display"></span><span class="loader spinner" style="visibility:hidden"></span> </button>

<script type="module">
    function show_spinner(button){
        let spinner = button.querySelector('.spinner');
        spinner.style.visibility = 'visible';
    }
    
    function hide_spinner(button){
        let spinner = button.querySelector('.spinner');
        spinner.style.visibility = 'hidden';
    }

    function display_status(button){
        let server_status_display = button.querySelector('.server_status_display');
        let status = button.dataset.status;
        let url = button.dataset.onSuccessUrl;
        let url_need_test = button.dataset.testOnSuccessUrl != "";
        let ready = button.dataset.ready;
        let friendly_messages = button.dataset.friendlyMessages != "";
        let server_name = button.dataset.serverName || "the server";

        if (status == "Error"){
            server_status_display.innerHTML = `Error while waking up ${server_name}... Please try again later.`;
            button.disabled = "";
            return;
        }

        let active = status == "Active";
        if (active && url && (url_need_test && ready || !url_need_test)){
            server_status_display.innerHTML = `${server_name} is ready, Click me`;
            button.disabled = "";
        } else if (active && url && url_need_test && !ready){
            server_status_display.innerHTML = `Waiting for ${server_name} to be ready...`;
        } else if (active){
            server_status_display.innerHTML = `${server_name} is <span class="active">Active</span> Click me`;
            button.disabled = "";
        } else if (status == "Archived"){
            button.disabled = "";
            let message = "Archived";
            if (friendly_messages)
                message = "sleeping";
            server_status_display.innerHTML = `${server_name} is <span class="no-active">${message}</span>`;
        } else {
            button.disabled = "disabled";
            if (friendly_messages)
                server_status_display.innerHTML = `Waking up ${server_name}...`;
            else
                server_status_display.innerHTML = `${server_name} is <span class="no-active">${status}</span>`;
        }
    }

    function update_status_until_active_success_url(button){
        let server_status_display = button.querySelector('.server_status_display');
        let url = button.dataset.onSuccessUrl;
        fetch('{% url "django_clouding_unarchive:server-is-ready" %}?url=' + encodeURIComponent(url), {method: 'HEAD'})
        .then(response => { 
            if (!response.ok)
                return Promise.reject(response);
            
            button.dataset.ready = "ready";
            display_status(button);
        }).catch(err => {
            button.dataset.ready = "";
            display_status(button);
            setTimeout(() => update_status_until_active_success_url(button), 5000);
        });
    }

    function update_status_until_active(button){
        let server_status_display = button.querySelector('.server_status_display');

        fetch(button.dataset.statusUrl)
        .then(response => response.text())
        .then(response_text => {
            console.log(response_text);
            button.dataset.status = response_text;
            display_status(button);
            if (response_text != "Active"){
                setTimeout(() => update_status_until_active(button), 5000);
            } else {
                if (button.dataset.onSuccessUrl && button.dataset.testOnSuccessUrl){
                    update_status_until_active_success_url(button);
                } else if (button.dataset.onSuccessUrl){
                    button.dataset.ready = "ready";
                    display_status(button);
                }
                hide_spinner(button);
            }
        }).catch(err => {
            console.log(err);
            button.dataset.status = "Error";
            display_status(button);
            button.disabled = "";
        });
    }

    for (let button of document.querySelectorAll('button.django-unarchive')){
        if (button.dataset.setup == "setup")
            continue;

        button.dataset.setup = "setup";
        button.addEventListener("click", event => {
            let button = event.target;
            let ready = button.dataset.ready != "";
            // TODO sometimes onSuccessUrl is undefined. See why.
            if (ready){
                console.log("url: ", button.dataset.onSuccessUrl);
                window.open(button.dataset.onSuccessUrl, '_blank');
                return;
            }
            show_spinner(button);
            button.disabled = "disabled";
            fetch(button.dataset.unarchiveUrl)
            .then(response => response.text())
            .then(response_text => {
                console.log(response_text);
                update_status_until_active(button);
            }).catch(err => {
                console.log(err);
                button.dataset.status = "Error";
                display_status(button);
                button.disabled = "";
            });
        });

        show_spinner(button);
        fetch(button.dataset.statusUrl)
        .then(response => response.text())
        .then(response_text => {
            console.log(response_text);
            button.dataset.status = response_text;
            if (response_text == "Active")
                button.dataset.ready = "ready";
            display_status(button);
        }).catch(err => {
            console.log(err);
            button.dataset.status = "Error";
            display_status(button);
        }).finally(() => {
            hide_spinner(button);
        });
    }
</script>
